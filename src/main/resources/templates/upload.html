<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload View</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="container">
    <div class="main-content-upload">
        <h2>Upload Item</h2>
        <div class="image-container">
            <img id="item-image" src="placeholder.jpg" alt="Item Image" style="max-width: 100%; height: auto" />
        </div>
        <input type="file" id="file-input" accept="image/*" />
        <div class="input-group">
            <label for="item-name-input">Item Name:</label>
            <input type="text" id="item-name-input" />
        </div>
        <div class="input-group">
            <label for="category-name">Category:</label>
            <span id="category-name" contenteditable="true">Click to set category</span>
        </div>
    </div>
    <div class="action-bar">
        <button onclick="snipImage()">Snip</button>
        <button onclick="getCategory()">Get Category</button>
        <button onclick="saveItem()">Add</button>
        <button class="delete-button" onclick="discard()">Discard</button>
    </div>
</div>

<script>
    document.getElementById("file-input").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("item-image").src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    function snipImage() {
        alert("Snip Out");
    }

    function getCategory() {
        document.getElementById("category-name").innerText = "Clothing";
    }

    async function saveItem() {
        const fileInput = document.getElementById("file-input");
        const file = fileInput.files[0];
        const itemName = document.getElementById("item-name-input").value;
        const categoryName = document.getElementById("category-name").innerText;
        const userEmail = localStorage.getItem('userEmail');

        if (!file || !itemName || !categoryName) {
            alert("Please fill out all fields and select an image.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("customerMail", userEmail);

        try {
            const uploadResponse = await fetch(`http://localhost:8080/upload/${userEmail}`, {
                method: "POST",
                body: formData,
            });

            if (!uploadResponse.ok) {
                throw new Error("Failed to upload file");
            }

            const uploadData = await uploadResponse.json();
            const itemId = uploadData.message.split(" itemId ")[1];

            const categoryResponse = await fetch(`http://localhost:8080/category`);
            const categories = await categoryResponse.json();
            const category = categories.find(cat => cat.name === categoryName);
            const categoryId = category ? category.id : null;

            if (!categoryId) {
                throw new Error("Invalid category name");
            }

            const updateResponse = await fetch(`http://localhost:8080/items/update/${itemId}/${categoryId}`, {
                method: "PUT",
            });

            if (!updateResponse.ok) {
                throw new Error("Failed to update item category");
            }

            alert("Item added and category set successfully!");
            window.location.href = "main.html";
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to add item: " + error.message);
        }
    }



    function discard() {
        window.location.href = "main.html"; // Return to main view without saving
    }
</script>
</body>
</html>

